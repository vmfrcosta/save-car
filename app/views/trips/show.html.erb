<div
  id="map"
  style="width: 100%;
  height: 600px;"
  data-markers="<%= @markers.to_json %>"
></div>

<div class="container mt-3">
  <div class="card p-3" id="infos-user" hidden>
    <div class="d-flex justify-content-around align-items-center">
      <div class="user-name">
        <h2><%= "#{@trip.car.user.first_name} #{@trip.car.user.last_name}" %></h2>
      </div>
      <div class="car-info">
        <p><%= "#{@trip.car.brand} #{@trip.car.model}" %></p>
        <p><%= @trip.car.plate %></p>
      </div>
      <p><%= @trip.dest_address %></p>
    </div>
    <div class="mt-3" id="arrived-btn">
      <%= simple_form_for @trip, remote: true do |f| %>
        <%= f.input :status, as: :hidden, value: 'arrived' %>
        <%= f.button :submit, 'Cheguei ao destino', class: 'btn btn-primary btn-block' %>
      <% end %>
    </div>
    <div class="mt-3" id="delivered-btn" hidden>
      <%= simple_form_for @trip do |f| %>
        <%= f.input :status, as: :hidden, value: 'delivered' %>
        <%= f.button :submit, 'Carro entregue ao destino correto', class: 'btn btn-success btn-block' %>
      <% end %>
    </div>
  </div>
</div>

<div class="container">
  <div class="card align-items-center" id="searching">
    <h2>Searching <i class="fas fa-spinner"></i></h2>
  </div>
</div>

<div class="container mt-3">
  <div class="card" id="infos-winch" hidden>
    <div class="d-flex justify-content-around align-items-center">
      <div class="user-name">
        <h2 id="winch-user-name"> winch.user.first_name winch.user.first_name </h2>
      </div>
      <div class="winch-info">
        <p id="winch-plate"> winch plate </p>
      </div>
    </div>
    <%= link_to 'delivered', delivered_trip_path(@trip), style: 'display: none' %>
  </div>
</div>

<% content_for :after_js do %>
  <script>
    App['trip_<%= @trip.id %>'] = App.cable.subscriptions.create(
      { channel: 'TripsChannel', trip_id: <%= @trip.id %> },
      { received: (data) => {
          console.log(data);
          console.log(data['locals']['lat'])
          <% if current_user == @trip.user %>
            updateUserMap(data['locals']['lat'], data['locals']['lng'], data['locals']['status'])
          <% end %>
        } 
      }
    );

    <% unless current_user == @trip.user %>
      setInterval(()=>{
        navigator.geolocation.getCurrentPosition(updateMap)
        const markers = eval(document.querySelector('#map').dataset.markers);
        const hidden = document.querySelector('#arrived-btn').hidden;
        const lat = markers[2]['lat'];
        const lng = markers[2]['lng'];
        const url = "<%= trip_win_loc_path(@trip.id) %>";
        fetch(`${url}?lat=${lat}&lng=${lng}&status=${status}&first_name=${first_name}&last_name=${last_name}&plate=${plate}`);
        console.log("info sent");
      }, 10000);
    <% end %>

    <% unless current_user == @trip.car.user %>
      document.querySelector('#infos-user').hidden = false
    <% end %>
  </script>
<% end %>
